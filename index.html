<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sicilia Meteo — ICON-2I</title>

  <!-- Leaflet CSS (doppio link: se uno fallisce spesso l'altro va) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    html, body { height: 100%; margin: 0; background:#0b0f14; }
    #map { height: 100%; width: 100%; background:#0b0f14; }

    .panel{
      position:absolute; z-index:1000; left:14px; top:14px;
      width:min(360px, calc(100vw - 28px));
      padding:14px 14px 12px; border-radius:14px;
      background:rgba(18,24,32,.86); backdrop-filter: blur(10px);
      color:#e9eef6; box-shadow:0 10px 30px rgba(0,0,0,.35);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      user-select:none;
    }
    .title{ font-size:18px; font-weight:700; margin-bottom:10px; }
    .btn{
      width:100%; background:#22314a; border:0; color:#e9eef6;
      padding:10px 12px; border-radius:12px; font-weight:700; cursor:pointer;
    }
    .btn:active{ transform:translateY(1px); }
    .row{ margin-top:10px; display:grid; gap:8px; }
    label{ display:flex; align-items:center; gap:10px; font-size:14px; }
    input[type="checkbox"]{ width:18px; height:18px; }

    .meta{ margin-top:10px; font-size:12px; line-height:1.35; color:rgba(233,238,246,.85); }
    .sliderWrap{ margin-top:10px; }
    .sliderHead{ display:flex; justify-content:space-between; font-size:12px; opacity:.9; margin-bottom:6px; }
    input[type="range"]{ width:100%; }

    .error{ color:#ff7b7b; font-size:12px; margin-top:8px; white-space:pre-wrap; }
    .ok{ color:#8effb5; }
    .hint{ margin-top:8px; font-size:11px; color:rgba(233,238,246,.65); }

    .leaflet-control-attribution{ display:none; }
  </style>

  <!-- Loader Leaflet JS con fallback automatico -->
  <script>
    function loadScript(src){
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.onload = resolve;
        s.onerror = () => reject(new Error("Errore caricamento: " + src));
        document.head.appendChild(s);
      });
    }

    async function ensureLeaflet(){
      // Provo jsDelivr, poi unpkg
      try{
        await loadScript("https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js");
        return true;
      } catch(e1){
        try{
          await loadScript("https://unpkg.com/leaflet@1.9.4/dist/leaflet.js");
          return true;
        } catch(e2){
          return false;
        }
      }
    }
  </script>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
    <div class="title">Sicilia — ICON-2I</div>

    <button class="btn" id="reloadBtn">Ricarica dati</button>

    <div class="row">
      <label><input id="chkTemp" type="checkbox"> Temperatura 2m</label>
      <label><input id="chkRain" type="checkbox"> Pioggia (oraria)</label>
      <label><input id="chkPres" type="checkbox"> Pressione</label>
      <label><input id="chkWind" type="checkbox"> Vento (particelle)</label>
    </div>

    <div class="sliderWrap">
      <div class="sliderHead">
        <span id="timeLabel">Ora previsione: —</span>
        <span id="hourLabel">0h</span>
      </div>
      <input id="hourSlider" type="range" min="0" max="0" step="1" value="0" />
    </div>

    <div class="meta">
      <div>Run: <span id="runLabel">—</span></div>
      <div>Status: <span id="statusLabel">—</span></div>
      <div>Punto: <span id="ptLabel">—</span></div>
      <div>Valore: <span id="valLabel">—</span></div>
      <div>Fonte dati: <span id="srcLabel">—</span></div>
    </div>

    <div id="errBox" class="error" style="display:none;"></div>
    <div class="hint">Tip: se lo sfondo resta vuoto, è quasi sempre CDN o tile bloccate dalla rete.</div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const FALLBACK_RUN = "2026013112";
    const DATA_DIR = "./data";
    const FILES = { temp:"temp_", rain:"rain_", pres:"pres_", wind:"wind_" };
    const EXT = ".json";

    const DEFAULT_VIEW_BOUNDS = [
      [36.35, 12.15],
      [38.40, 15.85]
    ];

    // =========================
    // UI
    // =========================
    const $ = (id) => document.getElementById(id);

    function setStatusOk(msg){
      $("statusLabel").innerHTML = `<span class="ok">${msg}</span>`;
    }
    function setStatus(msg){
      $("statusLabel").textContent = msg;
    }

    function showError(msg){
      const el = $("errBox");
      el.style.display = "block";
      el.textContent = msg;
    }
    function clearError(){
      const el = $("errBox");
      el.style.display = "none";
      el.textContent = "";
    }

    // Mostra errori JS direttamente nel pannello (su Android è oro)
    window.addEventListener("error", (e) => {
      showError("JS ERROR: " + (e.message || e.error || "sconosciuto"));
    });
    window.addEventListener("unhandledrejection", (e) => {
      showError("PROMISE ERROR: " + (e.reason?.message || e.reason || "sconosciuto"));
    });

    // =========================
    // FETCH (no-cache) + NaN fix
    // =========================
    async function fetchTextNoCache(url){
      const u = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
      const res = await fetch(u, { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status} su ${url}`);
      return await res.text();
    }

    function safeJsonParseWithNaN(text){
      const cleaned = text
        .replace(/\bNaN\b/g, "null")
        .replace(/\bInfinity\b/g, "null")
        .replace(/\b-Infinity\b/g, "null");
      return JSON.parse(cleaned);
    }

    async function fetchJSON(url){
      const text = await fetchTextNoCache(url);
      return safeJsonParseWithNaN(text);
    }

    async function loadRunMeta(){
      try{
        const meta = await fetchJSON(`${DATA_DIR}/run.json`);
        if(meta && (meta.run || meta.RUN || meta.date)){
          return String(meta.run || meta.RUN || meta.date).trim();
        }
      } catch(e){
        // ok, fallback
      }
      return FALLBACK_RUN;
    }

    function parseRunToDate(runStr){
      const y = Number(runStr.slice(0,4));
      const m = Number(runStr.slice(4,6)) - 1;
      const d = Number(runStr.slice(6,8));
      const hh = Number(runStr.slice(8,10));
      return new Date(Date.UTC(y,m,d,hh,0,0));
    }

    function fmtDateIT(dateUtc){
      const local = new Date(dateUtc.getTime());
      return local.toLocaleString("it-IT", {
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit"
      });
    }

    function pad3(n){ return String(n).padStart(3,"0"); }
    function urlFor(prefix, hour){ return `${DATA_DIR}/${prefix}${pad3(hour)}${EXT}`; }

    async function headOk(url){
      const u = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
      const res = await fetch(u, { method:"HEAD", cache:"no-store" });
      return res.ok;
    }

    async function detectMaxHour(){
      let h = 0;
      while(h < 200){
        const ok = await headOk(urlFor(FILES.temp, h));
        if(!ok) break;
        h++;
      }
      return Math.max(0, h-1);
    }

    // =========================
    // MAIN
    // =========================
    (async function main(){
      clearError();
      setStatus("Carico Leaflet…");

      const okLeaflet = await ensureLeaflet();
      if(!okLeaflet || typeof window.L === "undefined"){
        showError(
          "Leaflet NON si è caricato.\n" +
          "Quasi sicuramente la rete mobile sta bloccando unpkg/jsdelivr.\n\n" +
          "Prova: Wi-Fi oppure un altro browser.\n" +
          "Se vuoi, ti preparo la versione con Leaflet dentro al repo (zero CDN)."
        );
        setStatus("Leaflet: KO");
        return;
      }

      setStatusOk("Leaflet: OK. Carico mappa base…");

      // Init map
      const map = L.map("map", { zoomControl:true, preferCanvas:true });
      map.fitBounds(DEFAULT_VIEW_BOUNDS);

      // Basemap: provo 2 provider; se uno fallisce, spesso l'altro va
      let tileLoaded = false;

      function makeTile(url, options){
        const t = L.tileLayer(url, options);
        t.on("tileload", () => {
          if(!tileLoaded){
            tileLoaded = true;
            setStatusOk("Mappa base: OK. Dati pronti.");
          }
        });
        t.on("tileerror", () => {
          // non spammo; segnalo solo se non è mai arrivata una tile
          if(!tileLoaded){
            setStatus("Mappa base: errore tile… (provo fallback)");
          }
        });
        return t;
      }

      const osm = makeTile("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:18 });
      osm.addTo(map);

      // fallback “Carto” (spesso va anche quando OSM fa capricci)
      const carto = makeTile("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", { maxZoom:18 });

      // Se dopo 4 secondi non è arrivata nessuna tile, switcho
      setTimeout(() => {
        if(!tileLoaded){
          try{
            map.removeLayer(osm);
            carto.addTo(map);
            setStatus("Basemap fallback attivata…");
          } catch(e){}
        }
      }, 4000);

      // ====== Da qui in poi: UI “dati” (non impedisce basemap) ======
      let runStr = await loadRunMeta();
      const runDateUtc = parseRunToDate(runStr);

      $("runLabel").textContent = `${runStr} (${fmtDateIT(runDateUtc)})`;
      $("srcLabel").textContent = `MeteoHub / Agenzia ItaliaMeteo — ICON-2I (open data)`;

      const maxHour = await detectMaxHour();
      $("hourSlider").max = String(maxHour);
      $("hourSlider").value = "0";

      function updateTimeLabels(h){
        $("hourLabel").textContent = `+${h}h`;
        const dt = new Date(runDateUtc.getTime() + h*3600*1000);
        $("timeLabel").textContent = `Ora previsione: ${fmtDateIT(dt)}`;
      }
      updateTimeLabels(0);

      // Nota: per ora non attivo layer di default.
      // Se vuoi che si veda subito la temperatura, dimmelo e lo metto.

      $("hourSlider").addEventListener("input", (e) => {
        const h = Number(e.target.value);
        updateTimeLabels(h);
      });

      $("reloadBtn").addEventListener("click", () => {
        // semplice refresh pagina (su mobile spesso è la cosa più affidabile)
        location.reload();
      });

      // Se vuoi: qui agganciamo i tuoi overlay (temp/rain/pres/wind).
      // MA prima facciamo funzionare SEMPRE la basemap e lo “status”.
      // Quando mi confermi che ora vedi la mappa base stabile, reinseriamo gli overlay.
    })();
  </script>
</body>
</html>
